---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { createClient } from "../../lib/supabase";

const supabase = createClient(Astro);

// Auth Check (Admin Only)
const {
    data: { user },
} = await supabase.auth.getUser();
if (!user) return Astro.redirect("/login");

// TODO: Checking roles will be implemented later. For now assuming logged in user is admin.
// In real app, we check public.profiles.role === 'admin'

// Fetch All Orders
const { data: orders, error } = await supabase
    .from("orders")
    .select("*, profiles!inner(email), order_files(*)")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching orders:", error);
}

// Group Orders by Status
const toDoOrders = orders?.filter((o) => o.status === "payment_pending") || [];
const toTranslateOrders =
    orders?.filter((o) => o.status === "processing" || o.status === "paid") ||
    []; // Paid, ready to translate
const inReviewOrders = orders?.filter((o) => o.status === "review") || []; // Draft sent
const completedOrders = orders?.filter((o) => o.status === "completed") || [];

function formatPrice(price: number) {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
    }).format(price);
}
---

<AdminLayout title="Dashboard">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-slate-900">Dashboard Overview</h1>
        <p class="text-slate-500">Selamat datang kembali, Admin.</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <p
                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
            >
                Perlu Verifikasi
            </p>
            <p class="text-3xl font-bold text-slate-900">{toDoOrders.length}</p>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <p
                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
            >
                Siap Diterjemahkan
            </p>
            <p class="text-3xl font-bold text-blue-600">
                {toTranslateOrders.length}
            </p>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <p
                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
            >
                Sedang Review
            </p>
            <p class="text-3xl font-bold text-amber-500">
                {inReviewOrders.length}
            </p>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <p
                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1"
            >
                Total Selesai
            </p>
            <p class="text-3xl font-bold text-green-600">
                {completedOrders.length}
            </p>
        </div>
    </div>

    <!-- Kanban / List View -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Column 1: ACTIVE (Need Action) -->
        <div class="space-y-6">
            <h2
                class="font-bold text-lg text-slate-800 flex items-center gap-2"
            >
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                Siap Diterjemahkan
            </h2>

            {
                toTranslateOrders.length === 0 ? (
                    <div class="p-8 border-2 border-dashed border-slate-200 rounded-xl text-center text-slate-400 text-sm">
                        Tidak ada antrian terjemahan.
                    </div>
                ) : (
                    <div class="space-y-3">
                        {toTranslateOrders.map((order) => (
                            <a
                                href={`/admin/orders/${order.id}`}
                                class="block bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all group"
                            >
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-mono text-xs text-slate-500">
                                        #{order.id.slice(0, 8)}
                                    </span>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">
                                        PAID
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <p class="font-medium text-slate-900 group-hover:text-blue-600 transition-colors">
                                        {order.profiles?.email ||
                                            "Unknown User"}
                                    </p>
                                    <p class="text-xs text-slate-500 mt-1">
                                        Deadline:{" "}
                                        {new Date(
                                            new Date(order.created_at).setDate(
                                                new Date(
                                                    order.created_at,
                                                ).getDate() +
                                                    (order.urgency_days || 3),
                                            ),
                                        ).toLocaleDateString("id-ID")}
                                    </p>
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-500 border-t pt-3">
                                    <span>
                                        {order.page_count_estimated} Halaman
                                    </span>
                                    <span class="flex items-center gap-1 text-slate-900 font-medium">
                                        Lihat &rarr;
                                    </span>
                                </div>
                            </a>
                        ))}
                    </div>
                )
            }
        </div>

        <!-- Column 2: INCOMING (Verification) -->
        <div class="space-y-6">
            <h2
                class="font-bold text-lg text-slate-800 flex items-center gap-2"
            >
                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                Menunggu Pembayaran / Verifikasi
            </h2>

            {
                toDoOrders.length === 0 ? (
                    <div class="p-8 border-2 border-dashed border-slate-200 rounded-xl text-center text-slate-400 text-sm">
                        Tidak ada order baru.
                    </div>
                ) : (
                    <div class="space-y-3">
                        {toDoOrders.map((order) => (
                            <a
                                href={`/admin/orders/${order.id}`}
                                class="block bg-white p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:border-amber-300 transition-all"
                            >
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-mono text-xs text-slate-500">
                                        #{order.id.slice(0, 8)}
                                    </span>
                                    <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">
                                        Pending Payment
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <p class="font-medium text-slate-900">
                                        {order.profiles?.email}
                                    </p>
                                    <p class="text-sm text-slate-600 mt-1">
                                        Total:{" "}
                                        {formatPrice(order.final_price || 0)}
                                    </p>
                                </div>
                            </a>
                        ))}
                    </div>
                )
            }
        </div>
    </div>
</AdminLayout>
