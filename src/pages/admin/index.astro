---
import Layout from "../../layouts/Layout.astro";
import { createAstroSupabase } from "../../lib/supabase";
import { format } from "date-fns";
import { id } from "date-fns/locale";

const supabase = createAstroSupabase(Astro);

const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/");
}

// Check if user is admin
const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

if (profile?.role !== "admin") {
    return Astro.redirect("/");
}

// Fetch all orders
const { data: orders, error } = await supabase
    .from("orders")
    .select("*, profiles(email, full_name)")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching orders:", error);
}

function formatPrice(price: number) {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
    }).format(price);
}

function getStatusBadge(status: string) {
    switch (status) {
        case "pending_verification":
            return "bg-yellow-100 text-yellow-800 border-yellow-200";
        case "payment_pending":
            return "bg-blue-100 text-blue-800 border-blue-200";
        case "processing":
            return "bg-indigo-100 text-indigo-800 border-indigo-200";
        case "review":
            return "bg-purple-100 text-purple-800 border-purple-200";
        case "completed":
            return "bg-green-100 text-green-800 border-green-200";
        case "cancelled":
            return "bg-red-100 text-red-800 border-red-200";
        default:
            return "bg-gray-100 text-gray-800 border-gray-200";
    }
}
---

<Layout title="Admin Dashboard - Tarjuman">
    <nav class="border-b bg-card">
        <div
            class="container mx-auto flex h-16 items-center justify-between px-4"
        >
            <div class="flex items-center gap-2">
                <a href="/" class="text-xl font-serif font-bold text-foreground"
                    >Tarjuman</a
                >
                <span class="text-muted-foreground">/</span>
                <span class="font-medium">Admin</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs font-mono bg-slate-100 px-2 py-1 rounded"
                    >ADMIN MODE</span
                >
                <form action="/api/auth/signout" method="post">
                    <button
                        type="submit"
                        class="text-sm font-medium text-destructive hover:underline"
                    >
                        Keluar
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">Manage Orders</h1>

        <div class="rounded-xl border bg-card shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead
                        class="bg-muted/50 text-muted-foreground uppercase text-xs"
                    >
                        <tr>
                            <th class="px-6 py-3">Order ID</th>
                            <th class="px-6 py-3">User</th>
                            <th class="px-6 py-3">Date</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Amount</th>
                            <th class="px-6 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {
                            orders?.map((order) => (
                                <tr class="hover:bg-muted/30">
                                    <td class="px-6 py-4 font-mono">
                                        #{order.id.slice(0, 8)}
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-foreground">
                                            {/* @ts-ignore */}
                                            {order.profiles?.full_name ||
                                                "Unknown"}
                                        </div>
                                        <div class="text-xs text-muted-foreground">
                                            {/* @ts-ignore */}
                                            {order.profiles?.email}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        {format(
                                            new Date(order.created_at),
                                            "d MMM yyyy",
                                            { locale: id },
                                        )}
                                    </td>
                                    <td class="px-6 py-4">
                                        <span
                                            class={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${getStatusBadge(order.status)}`}
                                        >
                                            {order.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 font-medium">
                                        {formatPrice(
                                            order.final_price ||
                                                order.original_price,
                                        )}
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <a
                                            href={`/admin/orders/${order.id}`}
                                            class="text-primary hover:underline font-medium"
                                        >
                                            Manage
                                        </a>
                                    </td>
                                </tr>
                            ))
                        }
                    </tbody>
                </table>
                {
                    (!orders || orders.length === 0) && (
                        <div class="p-8 text-center text-muted-foreground">
                            No orders found.
                        </div>
                    )
                }
            </div>
        </div>
    </main>
</Layout>
