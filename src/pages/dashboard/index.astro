---
import Layout from "../../layouts/Layout.astro";
import { createAstroSupabase } from "../../lib/supabase";
import { format } from "date-fns";
import { id } from "date-fns/locale";

const supabase = createAstroSupabase(Astro);

const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/");
}

const { data: orders, error } = await supabase
    .from("orders")
    .select("*, order_files(*)")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching orders:", error);
}

function formatPrice(price: number) {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
    }).format(price);
}

function getStatusBadge(status: string) {
    switch (status) {
        case "pending_verification":
            return "bg-yellow-100 text-yellow-800 border-yellow-200";
        case "payment_pending":
            return "bg-blue-100 text-blue-800 border-blue-200";
        case "processing":
            return "bg-indigo-100 text-indigo-800 border-indigo-200";
        case "review":
            return "bg-purple-100 text-purple-800 border-purple-200";
        case "completed":
            return "bg-green-100 text-green-800 border-green-200";
        case "cancelled":
            return "bg-red-100 text-red-800 border-red-200";
        default:
            return "bg-gray-100 text-gray-800 border-gray-200";
    }
}

function getStatusLabel(status: string) {
    switch (status) {
        case "pending_verification":
            return "Menunggu Verifikasi";
        case "payment_pending":
            return "Menunggu Pembayaran";
        case "processing":
            return "Sedang Dikerjakan";
        case "review":
            return "Siap Direview";
        case "completed":
            return "Selesai";
        case "cancelled":
            return "Dibatalkan";
        default:
            return status;
    }
}
---

<Layout title="Dashboard - Tarjuman">
    <nav class="border-b bg-card">
        <div
            class="container mx-auto flex h-16 items-center justify-between px-4"
        >
            <div class="flex items-center gap-2">
                <a href="/" class="text-xl font-serif font-bold text-foreground"
                    >Tarjuman</a
                >
                <span class="text-muted-foreground">/</span>
                <span class="font-medium">Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-muted-foreground hidden sm:inline"
                    >{user.email}</span
                >
                <form action="/api/auth/signout" method="post">
                    <button
                        type="submit"
                        class="text-sm font-medium text-destructive hover:underline"
                    >
                        Keluar
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 sm:py-12">
        <header
            class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between"
        >
            <div>
                <h1 class="text-3xl font-serif font-bold text-foreground">
                    Riwayat Pesanan
                </h1>
                <p class="text-muted-foreground mt-1">
                    Pantau status terjemahan dokumen Anda di sini.
                </p>
            </div>
            <a
                href="/"
                class="inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm hover:bg-primary/90 sm:w-auto"
            >
                + Pesan Baru
            </a>
        </header>

        {
            (orders?.length || 0) === 0 ? (
                <div class="flex flex-col items-center justify-center rounded-2xl border border-dashed bg-muted/30 py-16 text-center">
                    <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-muted">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="text-muted-foreground"
                        >
                            <path d="M14 2v4a2 2 0 0 0 2 2h4" />
                            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z" />
                        </svg>
                    </div>
                    <h3 class="font-semibold text-lg">Belum ada pesanan</h3>
                    <p class="text-muted-foreground mb-6 max-w-sm">
                        Anda belum membuat pesanan terjemahan. Mulai pesanan
                        pertama Anda sekarang.
                    </p>
                    <a
                        href="/"
                        class="rounded-full bg-primary px-6 py-2 text-sm font-medium text-primary-foreground shadow-sm hover:bg-primary/90"
                    >
                        Buat Pesanan
                    </a>
                </div>
            ) : (
                <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    {orders?.map((order) => (
                        <a
                            href={`/dashboard/orders/${order.id}`}
                            class="group relative flex flex-col justify-between rounded-xl border bg-card p-6 shadow-sm transition-all hover:shadow-md hover:border-primary/50"
                        >
                            <div>
                                <div class="mb-4 flex items-center justify-between">
                                    <span
                                        class={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${getStatusBadge(order.status)}`}
                                    >
                                        {getStatusLabel(order.status)}
                                    </span>
                                    <span class="text-xs text-muted-foreground">
                                        {format(
                                            new Date(order.created_at),
                                            "d MMM yyyy",
                                            { locale: id },
                                        )}
                                    </span>
                                </div>

                                <div class="mb-4">
                                    <div class="text-sm text-muted-foreground mb-1">
                                        Total Estimasi
                                    </div>
                                    <div class="text-2xl font-bold text-foreground font-serif">
                                        {formatPrice(
                                            order.final_price ||
                                                order.original_price,
                                        )}
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <div class="text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                        Dokumen
                                    </div>
                                    {order.order_files
                                        ?.slice(0, 3)
                                        .map((file: any) => (
                                            <div class="flex items-center gap-2 text-sm text-foreground/80">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    width="14"
                                                    height="14"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    class="text-muted-foreground"
                                                >
                                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                                    <polyline points="14 2 14 8 20 8" />
                                                </svg>
                                                <span class="truncate block max-w-[200px]">
                                                    {file.file_path
                                                        .split("/")
                                                        .pop()}
                                                </span>
                                            </div>
                                        ))}
                                    {(order.order_files?.length || 0) > 3 && (
                                        <div class="text-xs text-muted-foreground padding-left-6">
                                            +{" "}
                                            {(order.order_files?.length || 0) -
                                                3}{" "}
                                            file lainnya
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div class="mt-6 pt-4 border-t flex items-center justify-between text-sm text-primary font-medium">
                                <span class="group-hover:underline">
                                    Lihat Detail
                                </span>
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="transition-transform group-hover:translate-x-1"
                                >
                                    <path d="M5 12h14" />
                                    <path d="m12 5 7 7-7 7" />
                                </svg>
                            </div>
                        </a>
                    ))}
                </div>
            )
        }
    </main>
</Layout>
