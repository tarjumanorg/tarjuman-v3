---
import Layout from "../../../layouts/Layout.astro";
import { createAstroSupabase } from "../../../lib/supabase";
import { format } from "date-fns";
import { id as localeId } from "date-fns/locale";

const { id } = Astro.params;
const supabase = createAstroSupabase(Astro);

const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/");
}

// Fetch order details with security check (RLS handles it, but explicit check is good)
const { data: order, error } = await supabase
    .from("orders")
    .select("*, order_files(*)")
    .eq("id", id)
    .single();

if (error || !order) {
    return Astro.redirect("/dashboard");
}

function formatPrice(price: number) {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
    }).format(price);
}

function getStatusLabel(status: string) {
    switch (status) {
        case "pending_verification":
            return "Menunggu Verifikasi";
        case "payment_pending":
            return "Menunggu Pembayaran";
        case "processing":
            return "Sedang Dikerjakan";
        case "review":
            return "Siap Direview";
        case "completed":
            return "Selesai";
        case "cancelled":
            return "Dibatalkan";
        default:
            return status;
    }
}
---

<Layout title={`Pesanan #${order.id.slice(0, 8)} - Tarjuman`}>
    <nav class="border-b bg-card">
        <div
            class="container mx-auto flex h-16 items-center justify-between px-4"
        >
            <div class="flex items-center gap-2">
                <a href="/" class="text-xl font-serif font-bold text-foreground"
                    >Tarjuman</a
                >
                <span class="text-muted-foreground">/</span>
                <a href="/dashboard" class="font-medium hover:text-primary"
                    >Dashboard</a
                >
                <span class="text-muted-foreground">/</span>
                <span class="font-medium">#{order.id.slice(0, 8)}</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-muted-foreground hidden sm:inline"
                    >{user.email}</span
                >
                <form action="/api/auth/signout" method="post">
                    <button
                        type="submit"
                        class="text-sm font-medium text-destructive hover:underline"
                    >
                        Keluar
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 sm:py-12">
        <div class="mb-8">
            <a
                href="/dashboard"
                class="text-sm text-muted-foreground hover:text-primary mb-4 inline-flex items-center gap-1"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="m15 18-6-6 6-6"></path></svg
                >
                Kembali ke Dashboard
            </a>
            <div
                class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
            >
                <div>
                    <h1
                        class="text-2xl sm:text-3xl font-serif font-bold text-foreground flex items-center gap-3"
                    >
                        Pesanan #{order.id.slice(0, 8)}
                    </h1>
                    <p class="text-muted-foreground mt-1">
                        Dibuat pada {
                            format(
                                new Date(order.created_at),
                                "d MMMM yyyy, HH:mm",
                                { locale: localeId },
                            )
                        }
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <span
                        class="px-3 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary border border-primary/20"
                    >
                        {getStatusLabel(order.status)}
                    </span>
                </div>
            </div>
        </div>

        <div class="grid gap-8 lg:grid-cols-3">
            <!-- Left Column: Order Details & Files -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Files Section -->
                <div
                    class="rounded-xl border bg-card shadow-sm overflow-hidden"
                >
                    <div class="border-b bg-muted/30 px-6 py-4">
                        <h2 class="font-semibold">Dokumen Referensi</h2>
                    </div>
                    <div class="p-6">
                        {
                            order.order_files &&
                            order.order_files.length > 0 ? (
                                <div class="grid gap-4 sm:grid-cols-2">
                                    {order.order_files.map((file: any) => (
                                        <div class="flex items-start gap-3 rounded-lg border p-3 hover:bg-muted/50 transition-colors">
                                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded bg-primary/10 text-primary">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    width="20"
                                                    height="20"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                >
                                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                                    <polyline points="14 2 14 8 20 8" />
                                                </svg>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <p
                                                    class="truncate text-sm font-medium text-foreground"
                                                    title={file.file_path
                                                        .split("/")
                                                        .pop()}
                                                >
                                                    {file.file_path
                                                        .split("/")
                                                        .pop()
                                                        .replace(/_/g, " ")}
                                                </p>
                                                <p class="text-xs text-muted-foreground">
                                                    {file.page_count} Halaman
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p class="text-muted-foreground text-sm italic">
                                    Tidak ada file yang terlampir.
                                </p>
                            )
                        }
                    </div>
                </div>

                <!-- Timeline Section (Placeholder for now) -->
                <div
                    class="rounded-xl border bg-card shadow-sm overflow-hidden"
                >
                    <div class="border-b bg-muted/30 px-6 py-4">
                        <h2 class="font-semibold">Status Pengerjaan</h2>
                    </div>
                    <div class="p-6">
                        <div
                            class="relative pl-4 border-l-2 border-muted space-y-8"
                        >
                            <div class="relative">
                                <div
                                    class="absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-primary ring-4 ring-background"
                                >
                                </div>
                                <p class="text-sm font-medium">
                                    Pesanan Dibuat
                                </p>
                                <p class="text-xs text-muted-foreground">
                                    {
                                        format(
                                            new Date(order.created_at),
                                            "d MMM HH:mm",
                                            { locale: localeId },
                                        )
                                    }
                                </p>
                            </div>
                            <!-- More timeline items based on status logic later -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="space-y-6">
                <div
                    class="rounded-xl border bg-card shadow-sm overflow-hidden sticky top-8"
                >
                    <div class="border-b bg-muted/30 px-6 py-4">
                        <h2 class="font-semibold">Rincian Biaya</h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted-foreground"
                                >Estimasi Halaman</span
                            >
                            <span class="font-medium"
                                >{order.page_count_estimated} Hal</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-muted-foreground"
                                >Layanan ({order.urgency_days} Hari)</span
                            >
                            <span class="font-medium">Reguler</span>
                        </div>
                        {
                            order.physical_copy && (
                                <>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-muted-foreground">
                                            Hard Copy (Cap Basah)
                                        </span>
                                        <span class="font-medium">Ya</span>
                                    </div>
                                    <div class="text-xs text-muted-foreground bg-muted p-2 rounded">
                                        <>
                                            <strong>Alamat:</strong>
                                            <br />
                                        </>
                                        {order.hard_copy_address}
                                    </div>
                                </>
                            )
                        }
                        <div
                            class="border-t pt-4 flex justify-between items-center"
                        >
                            <span class="font-semibold">Total Total</span>
                            <span
                                class="text-xl font-serif font-bold text-primary"
                            >
                                {
                                    formatPrice(
                                        order.final_price ||
                                            order.original_price,
                                    )
                                }
                            </span>
                        </div>

                        {
                            (order.status === "pending_verification" ||
                                order.status === "payment_pending") && (
                                <button class="w-full rounded-full bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm hover:bg-primary/90 mt-4">
                                    Bayar Sekarang
                                </button>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>
