---
import Layout from "../../../layouts/Layout.astro";
import { createClient } from "../../../lib/supabase";

const { id } = Astro.params;
const supabase = createClient(Astro);

if (!id) return Astro.redirect("/404");

// Parse Duitku redirect query params
const resultCode = Astro.url.searchParams.get("resultCode") || "";
const reference = Astro.url.searchParams.get("reference") || "";

// Auth Check
const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) return Astro.redirect("/login");

// Fetch Order to confirm it exists and belongs to user
const { data: order, error } = await supabase
    .from("orders")
    .select("*")
    .eq("id", id)
    .single();

if (error || !order) return Astro.redirect("/404");
if (order.user_id !== user.id) return Astro.redirect("/404");

// Determine payment status display
const isPaid = order.payment_status === "paid" || resultCode === "00";
const isPending =
    !isPaid &&
    (order.payment_status === "pending" ||
        resultCode === "01" ||
        resultCode === "");
const isFailed = resultCode === "02";

// Calculate ETA
const createdDate = new Date(order.created_at);
const urgencyDays = order.urgency_days || 3;
const etaDate = new Date(createdDate);
etaDate.setDate(etaDate.getDate() + urgencyDays);

const formattedETA = etaDate.toLocaleDateString("id-ID", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
});

// Status config
const statusConfig = isPaid
    ? {
          icon: "check",
          color: "primary",
          title: "Alhamdulillah! Pembayaran Diterima",
          tagText: "Sedang Dikerjakan",
          tagClass: "text-blue-600 bg-blue-50",
      }
    : isFailed
      ? {
            icon: "x",
            color: "destructive",
            title: "Pembayaran Gagal",
            tagText: "Gagal",
            tagClass: "text-red-600 bg-red-50",
        }
      : {
            icon: "clock",
            color: "amber-500",
            title: "Menunggu Pembayaran",
            tagText: "Menunggu Konfirmasi",
            tagClass: "text-amber-600 bg-amber-50",
        };
---

<Layout title={`${statusConfig.title} - Tarjuman`}>
    <div class="container mx-auto py-20 px-4 max-w-2xl text-center">
        <div class="mb-8 flex justify-center">
            <div
                class={`rounded-full bg-${statusConfig.color}/10 p-6 text-${statusConfig.color}`}
            >
                {
                    isPaid ? (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="48"
                            height="48"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
                            <path d="m9 12 2 2 4-4" />
                        </svg>
                    ) : isFailed ? (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="48"
                            height="48"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <circle cx="12" cy="12" r="10" />
                            <path d="m15 9-6 6" />
                            <path d="m9 9 6 6" />
                        </svg>
                    ) : (
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="48"
                            height="48"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    )
                }
            </div>
        </div>

        <h1 class="font-serif text-3xl font-bold text-foreground mb-4">
            {statusConfig.title}
        </h1>

        {
            isPaid && (
                <p class="text-lg text-muted-foreground mb-8">
                    Terima kasih telah mempercayakan dokumenmu kepada Tarjuman.{" "}
                    <br class="hidden sm:inline" />
                    Penerjemah tersumpah kami telah menerima pesananmu dan akan
                    segera memprosesnya.
                </p>
            )
        }

        {
            isPending && (
                <p class="text-lg text-muted-foreground mb-8">
                    Pembayaranmu sedang diproses. Kami akan mengerjakan
                    dokumenmu segera setelah pembayaran dikonfirmasi.
                    <br class="hidden sm:inline" />
                    <span class="text-sm">
                        Halaman ini bisa ditutup â€” status akan diperbarui
                        otomatis di dashboard.
                    </span>
                </p>
            )
        }

        {
            isFailed && (
                <p class="text-lg text-muted-foreground mb-8">
                    Pembayaran dibatalkan atau gagal. Kamu bisa mencoba lagi
                    melalui halaman pembayaran.
                </p>
            )
        }

        <div
            class="bg-card border border-border rounded-xl p-6 mb-8 text-left max-w-md mx-auto shadow-sm"
        >
            <h3 class="font-semibold mb-4 text-center border-b pb-2">
                Detail Singkat
            </h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Order ID</span>
                    <span class="font-mono">{id.slice(0, 8)}...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Status</span>
                    <span
                        class={`font-medium ${statusConfig.tagClass} px-2 py-0.5 rounded`}
                    >
                        {statusConfig.tagText}
                    </span>
                </div>
                {
                    (isPaid || isPending) && (
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">
                                Estimasi Selesai
                            </span>
                            <span class="font-bold text-primary">
                                {formattedETA}
                            </span>
                        </div>
                    )
                }
                {
                    reference && (
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Referensi</span>
                            <span class="font-mono text-xs">{reference}</span>
                        </div>
                    )
                }
            </div>
        </div>

        <div
            class="flex flex-col sm:flex-row items-center justify-center gap-4"
        >
            {
                isFailed ? (
                    <a
                        href={`/payment/${id}`}
                        class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-primary px-8 py-3 text-sm font-bold text-primary-foreground shadow-lg hover:bg-primary/90 transition-transform active:scale-95"
                    >
                        Coba Bayar Lagi
                    </a>
                ) : (
                    <a
                        href="/dashboard"
                        class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-primary px-8 py-3 text-sm font-bold text-primary-foreground shadow-lg hover:bg-primary/90 transition-transform active:scale-95"
                    >
                        Lihat Pesanan Saya
                    </a>
                )
            }
            <a
                href="/"
                class="w-full sm:w-auto inline-flex items-center justify-center rounded-full border border-input bg-background px-8 py-3 text-sm font-medium hover:bg-accent transition-colors"
            >
                Kembali ke Beranda
            </a>
        </div>
    </div>
</Layout>
