---
import Layout from "../../../layouts/Layout.astro";
import { createClient } from "../../../lib/supabase";

const { id } = Astro.params;
const supabase = createClient(Astro);

if (!id) return Astro.redirect("/404");

// Auth Check
const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) return Astro.redirect("/login");

// Fetch Order to confirm it exists and belongs to user
const { data: order, error } = await supabase
    .from("orders")
    .select("*")
    .eq("id", id)
    .single();

if (error || !order) return Astro.redirect("/404");
if (order.user_id !== user.id) return Astro.redirect("/404");

// Calculate ETA
const createdDate = new Date(order.created_at);
const urgencyDays = order.urgency_days || 3;
const etaDate = new Date(createdDate);
etaDate.setDate(etaDate.getDate() + urgencyDays);

const formattedETA = etaDate.toLocaleDateString("id-ID", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
});
---

<Layout title="Pembayaran Berhasil - Tarjuman">
    <div class="container mx-auto py-20 px-4 max-w-2xl text-center">
        <div class="mb-8 flex justify-center">
            <div class="rounded-full bg-green-100 p-6 text-green-600">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="lucide lucide-check-circle-2"
                >
                    <path
                        d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                    ></path>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
            </div>
        </div>

        <h1 class="font-serif text-3xl font-bold text-foreground mb-4">
            Alhamdulillah! Pembayaran Diterima
        </h1>

        <p class="text-lg text-muted-foreground mb-8">
            Terima kasih telah mempercayakan dokumenmu kepada Tarjuman. <br
                class="hidden sm:inline"
            />
            Penerjemah tersumpah kami telah menerima pesananmu dan akan segera memprosesnya.
        </p>

        <div
            class="bg-card border border-border rounded-xl p-6 mb-8 text-left max-w-md mx-auto shadow-sm"
        >
            <h3 class="font-semibold mb-4 text-center border-b pb-2">
                Detail Singkat
            </h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Order ID</span>
                    <span class="font-mono">{id.slice(0, 8)}...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Status</span>
                    <span
                        class="font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded"
                        >Sedang Dikerjakan</span
                    >
                </div>
                <div class="flex justify-between">
                    <span class="text-muted-foreground">Estimasi Selesai</span>
                    <span class="font-bold text-primary">{formattedETA}</span>
                </div>
            </div>
        </div>

        <div
            class="flex flex-col sm:flex-row items-center justify-center gap-4"
        >
            <a
                href="/dashboard"
                class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-primary px-8 py-3 text-sm font-bold text-primary-foreground shadow-lg hover:bg-primary/90 transition-transform active:scale-95"
            >
                Lihat Pesanan Saya
            </a>
            <a
                href="/"
                class="w-full sm:w-auto inline-flex items-center justify-center rounded-full border border-input bg-background px-8 py-3 text-sm font-medium hover:bg-accent transition-colors"
            >
                Kembali ke Beranda
            </a>
        </div>
    </div>
</Layout>
